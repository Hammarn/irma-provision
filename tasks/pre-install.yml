--- 

  # These tasks need to run before any other roles, to setup proper 
  # environment variables depending on we're deploying to production, 
  # staging, or development/test purposes. 
  
  # TODO: Perhaps this logic can be made more pretty somehow. 

  - fail: msg="You must specify '-e deployment_environment=<production|staging|devel>'"
    when: deployment_environment not in [ "production", "staging", "devel" ]

  # Generate a semi-unique root folder for devel deployment. 
  # Depends on that we're standing inside the git repo while running the ansible-playbook command. 
  - shell: echo `whoami`_`git rev-parse --abbrev-ref HEAD` 
    when: deployment_environment == "devel"  
    register: devel_version

  - set_fact: 
      root_path: "/lupus/ngi/irma3/devel-root/{{ devel_version.stdout }}"
    when: deployment_environment == "devel" 

  - debug: msg="Ignoring deployment_version for devel deployment. Using autogenerated {{ devel_version.stdout }} instead."
    when: deployment_environment == "devel" and "deployment_version" != "default"

  - fail: msg="You must specify a version to deploy for production/staging with '-e deployment_version=<github release tag|commit hash>'"
    when: (deployment_environment == "staging" or deployment_environment == "production") and deployment_version == "default"

  - set_fact: 
      root_path: "/lupus/ngi/{{ deployment_environment }}/{{ deployment_version }}"
    when: deployment_environment == "staging" or deployment_environment == "production"

  - stat: path={{ root_path }} 
    register: p
    when: deployment_environment == "staging" or deployment_environment == "production"

  - fail: msg="Aborting! Directory {{ root_path }} already exists. Remove the dir or call playbook with '-e deployment_override=true' if you want to deploy anyway."
    when: (deployment_environment == "staging" or deployment_environment == "production") and deployment_override == false and p.stat.isdir is defined and p.stat.isdir

